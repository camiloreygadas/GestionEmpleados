{% extends 'base.html' %}

{% block title %}Gestión de Empleados{% endblock %}

{% block content %}
<style>
/* ===================================================================== */
/* CSS OPTIMIZADO PARA gestionar_empleados.html                         */
/* ===================================================================== */

/* VARIABLES CSS - TEMA CLARO */
:root {
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-tertiary: #e9ecef;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --text-muted: #adb5bd;
    --border-color: #dee2e6;
    --accent-color: #0d6efd;
    --success-color: #198754;
    --danger-color: #dc3545;
    --warning-color: #fd7e14;
    --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
    --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-hover: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    --gradient-import: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%);
}

/* ========================================================== */
/* =====> INICIO DE LA CORRECCIÓN: TEMA OSCURO MEJORADO  <===== */
/* ========================================================== */
[data-bs-theme="dark"] {
    --bg-primary: #111827; /* Gris-900: más suave que el negro puro */
    --bg-secondary: #1f2937; /* Gris-800 */
    --bg-tertiary: #374151; /* Gris-700 */
    --text-primary: #f9fafb; /* Gris-50: blanco suave, menos duro para la vista */
    --text-secondary: #d1d5db; /* Gris-300 */
    --text-muted: #6b7280; /* Gris-500 */
    --border-color: #374151; /* Gris-700 */
    --accent-color: #3b82f6; /* Azul-500: un azul más moderno */
    --success-color: #22c55e; /* Verde-500 */
    --danger-color: #ef4444; /* Rojo-500 */
    --warning-color: #f97316; /* Naranja-500 */
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
    --gradient-bg: linear-gradient(135deg, #1e3a8a 0%, #4338ca 100%); /* Degradado de azul a índigo */
    --gradient-import: linear-gradient(135deg, #1e40af 0%, #5b21b6 100%); /* Degradado de azul a morado */
}
/* ========================================================== */
/* =====> FIN DE LA CORRECCIÓN                             <===== */
/* ========================================================== */


/* LAYOUT PRINCIPAL */
.escape-container {
    width: 100vw !important;
    position: relative !important;
    left: 50% !important;
    right: 50% !important;
    margin-left: -50vw !important;
    margin-right: -50vw !important;
    max-width: none !important;
}

.content-wrapper {
    padding: 1rem 2rem;
}

@media (min-width: 768px) { .content-wrapper { padding: 1rem 4rem; } }
@media (min-width: 1200px) { .content-wrapper { padding: 1rem 6rem; } }
@media (min-width: 1400px) { .content-wrapper { padding: 1rem 8rem; } }

/* ESTILOS BASE */
* { transition: all 0.3s ease; }
body { 
    background: var(--bg-secondary) !important; 
    color: var(--text-primary) !important; 
}

/* CARDS Y CONTENEDORES */
.card {
    margin-bottom: 2rem;
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

.card-body { padding: 2rem; }
.card-header {
    padding: 1.5rem 2rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    border-radius: 1rem 1rem 0 0;
}

.card-header h5 {
    font-size: 1.25rem;
    margin: 0;
    color: var(--text-primary);
}

/* HEADER CON GRADIENTE */
.header-gradient {
    background: var(--gradient-bg);
    padding: 3rem 0;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
    width: 100vw;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
}

.header-title {
    color: white;
    font-weight: 700;
    font-size: 2.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    margin: 0;
    text-align: center;
}

@media (max-width: 767px) {
    .header-title { font-size: 1.8rem; }
    .content-wrapper { padding: 1rem; }
}

/* TOGGLE DE TEMA */
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    background: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: 50px;
    padding: 0.75rem 1.25rem;
    box-shadow: var(--shadow-lg);
}

.theme-toggle-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 25px;
}

/* FORMULARIOS */
.form-control, .form-select {
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-control:focus, .form-select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

[data-bs-theme="dark"] .form-control::placeholder {
    color: var(--text-muted);
}

.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.form-label.required::after {
    content: ' *';
    color: var(--danger-color);
}

/* --- Feedback de validación --- */
.form-feedback {
    display: block;
    width: 100%;
    margin-top: .25rem;
    font-size: .875em;
    color: var(--danger-color);
}
.was-validated .form-control:invalid ~ .form-feedback,
.was-validated .form-control:invalid ~ .valid-feedback {
    display: block;
}
.form-control.is-invalid ~ .form-feedback {
    display: block;
}

/* BOTONES */
.btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    border: none;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.nav-btn {
    min-width: 250px;
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 0.75rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    background: rgba(255, 255, 255, 0.95);
    color: var(--accent-color);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.nav-btn:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    text-decoration: none;
}

[data-bs-theme="dark"] .nav-btn {
    background: rgba(0, 0, 0, 0.25);
    color: var(--text-primary);
    border-color: rgba(255, 255, 255, 0.1);
}

/* TABLAS */
.table th, .table td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color);
}

.table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table tbody tr:hover {
    background: var(--bg-secondary);
}

/* ELEMENTOS INTERACTIVOS */
.clickable-field {
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
    display: inline-block;
    font-weight: 500;
}

.clickable-field:hover {
    background: var(--accent-color);
    color: white;
    transform: scale(1.02);
}

.clickable-field.selected {
    background: var(--success-color);
    color: white;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
}

/* NAVEGACIÓN POR TABS */
.nav-tabs {
    border: none;
    background: var(--bg-primary);
    border-radius: 1rem 1rem 0 0;
    padding: 1rem 1rem 0;
}

.nav-tabs .nav-link {
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    border: none;
    border-radius: 0.5rem 0.5rem 0 0;
    color: var(--text-secondary);
    margin-right: 0.25rem;
}

.nav-tabs .nav-link:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.nav-tabs .nav-link.active {
    background: var(--accent-color);
    color: white;
}

.tab-pane { padding: 2rem; }

/* BADGES Y ALERTAS */
.badge {
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.alert {
    border: none;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.alert-info {
    background: rgba(13, 202, 240, 0.1);
    color: var(--text-primary);
    border-left: 4px solid #0dcaf0;
}
[data-bs-theme="dark"] .alert-info {
    background-color: rgba(59, 130, 246, 0.1);
    border-left-color: var(--accent-color);
}

/* MODALES */
.modal-xl { max-width: 1200px; }

.modal-header {
    border: none;
    padding: 1.5rem;
    background: var(--gradient-bg);
    color: white;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.modal-body { padding: 1.5rem; }

.modal-footer {
    border: none;
    padding: 1rem 1.5rem;
    background: var(--bg-secondary);
}

/* PASOS DEL MODAL */
.step-navigation {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.steps-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
}

.step-number {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.step.active .step-number {
    background: var(--accent-color);
    color: white;
}

.step.completed .step-number {
    background: var(--success-color);
    color: white;
}

/* SISTEMA DE NOTIFICACIONES TOAST */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
    pointer-events: none;
}

.toast-notification {
    background: var(--bg-primary);
    border-radius: 0.75rem;
    box-shadow: var(--shadow-lg);
    border-left: 4px solid;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideIn 0.4s ease forwards;
    pointer-events: all;
}

.toast-notification.toast-success { border-left-color: var(--success-color); }
.toast-notification.toast-error { border-left-color: var(--danger-color); }
.toast-notification.toast-warning { border-left-color: var(--warning-color); }
.toast-notification.toast-info { border-left-color: var(--accent-color); }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
/* HERRAMIENTAS MASIVAS Y DROPZONE */
.bg-gradient-success {
    background: linear-gradient(135deg, #198754, #28a745);
}

.dropzone-container {
    border: 3px dashed var(--border-color);
    border-radius: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    transition: all 0.3s ease;
}

.dropzone-container.drag-over {
    border-color: var(--accent-color);
    background: rgba(59, 130, 246, 0.05);
}

.dropzone {
    text-align: center;
    padding: 2rem;
}

.upload-icon {
    font-size: 3rem;
    color: var(--accent-color);
    margin-bottom: 1rem;
}

.upload-title {
    font-weight: 600;
}

.btn-link {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    background: none;
    border: none;
    cursor: pointer;
}

.btn-link:hover {
    text-decoration: underline;
}

/* VISTA PREVIA DEL ARCHIVO */
.file-preview .file-info {
    display: flex;
    align-items: center;
    text-align: left;
    padding: 1rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
}

.file-icon {
    font-size: 2.5rem;
    margin-right: 1rem;
}

.file-details {
    flex-grow: 1;
}

.file-name {
    margin: 0;
    font-weight: 600;
}

/* IMPORTACIÓN INTELIGENTE MODAL */
.bg-gradient-import {
    background: var(--gradient-import);
}

.import-progress-steps {
    padding: 1rem 2rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.step-indicator {
    display: flex;
    justify-content: space-between;
    position: relative;
}

.step-indicator .step {
    z-index: 1;
}

.step-indicator::before {
    content: '';
    position: absolute;
    top: 17px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 0;
}

.step-indicator .step.active ~ .step::before {
    background: var(--border-color);
}

.step-indicator .step.active .step-number {
    border-color: var(--accent-color);
}

.step-title {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.step.active .step-title {
    color: var(--text-primary);
    font-weight: 600;
}
.drag-drop-zone{
    border: 2px dashed var(--border-color);
    padding: 2rem;
    text-align: center;
    border-radius: 1rem;
    cursor: pointer;
}
.drag-drop-zone.drag-over {
    border-color: var(--accent-color);
    background-color: var(--bg-tertiary);
}
.validation-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
}

#preview-table {
    font-size: 0.85rem;
}

#preview-table thead {
    position: sticky;
    top: 0;
    z-index: 1;
}
/* Estilos para filas de error en la tabla de vista previa */
#preview-table tbody tr.table-danger td {
    background-color: rgba(220, 53, 69, 0.1) !important;
    color: var(--danger-color);
}
#preview-table tbody tr.table-danger td span.badge {
    background-color: var(--danger-color) !important;
    color: white;
}


.errors-container .card {
    margin-bottom: 1rem;
}
/* --- Estilos para la sección de corrección de errores --- */
.correction-header {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 0.75rem;
}
.error-card {
    border-left: 4px solid var(--danger-color);
}
.error-card .card-body {
    padding: 1rem 1.5rem;
}
.error-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem 1rem;
    font-size: 0.9rem;
}
.error-field strong {
    color: var(--danger-color);
}


.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}
.summary-card {
    padding: 1rem;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}
.summary-card.success { background-color: rgba(34, 197, 94, 0.1); }
.summary-card.warning { background-color: rgba(249, 115, 22, 0.1); }
.summary-card.danger { background-color: rgba(239, 68, 68, 0.1); }
.summary-card.info { background-color: rgba(59, 130, 246, 0.1); }
.summary-card .card-icon { font-size: 2rem; }
.summary-card.success .card-icon { color: var(--success-color); }
.summary-card.warning .card-icon { color: var(--warning-color); }
.summary-card.danger .card-icon { color: var(--danger-color); }
.summary-card.info .card-icon { color: var(--accent-color); }
.card-number { font-size: 1.5rem; font-weight: 700; }
.card-label { font-size: 0.8rem; color: var(--text-secondary); }

/* SCROLL PERSONALIZADO */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { 
    background: var(--border-color); 
    border-radius: 4px; 
}
::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
</style>

<div class="theme-toggle">
    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Cambiar tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>
</div>

<div class="escape-container">
    <div class="content-wrapper">
        
        <div class="header-gradient">
            <div class="text-center">
                <h1 class="header-title">
                    <i class="fas fa-users me-3"></i>
                    Gestión de Empleados
                </h1>
                <p class="text-white-50 mb-0 fs-5">Sistema integral de administración de personal</p>
            </div>
        <div class="card shadow-sm mb-5">
            <div class="card-body d-flex justify-content-center flex-wrap gap-4 py-4">
                <a href="{{ url_for('registrar_asistencia') }}" class="nav-btn">
                    <i class="fas fa-calendar-check"></i>
                    <span>Ir a Registro de Asistencia</span>
                </a>
                <a href="{{ url_for('reportes') }}" class="nav-btn">
                    <i class="fas fa-chart-pie"></i>
                    <span>Módulo de Reportes</span>
                </a>
                <a href="{{ url_for('gestion_turnos') }}" class="nav-btn">
                <i class="fas fa-calendar-days"></i>
                <span>Gestión de Turnos</span>
            </a>
            <a href="{{ url_for('dashboard_analytics') }}" class="nav-btn">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard Historial de Cambios</span>
            </a>
            <a href="{{ url_for('gestion_sueldos_cargos') }}" class="nav-btn">
                <i class="fas fa-dollar-sign"></i>
                <span>Gestión de Sueldos</span>
            </a>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista-pane" type="button" role="tab" aria-controls="lista-pane" aria-selected="true">
                    <i class="fas fa-list me-2"></i>Lista de Empleados
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar-pane" type="button" role="tab" aria-controls="registrar-pane" aria-selected="false">
                    <i class="fas fa-user-plus me-2"></i>Registrar Nuevo Empleado
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="herramientas-tab" data-bs-toggle="tab" data-bs-target="#herramientas-pane" type="button" role="tab" aria-controls="herramientas-pane" aria-selected="false">
                    <i class="fas fa-tools me-2"></i>Herramientas Masivas
                </button>
            </li>
        </ul>

        <div class="tab-content card border-top-0 rounded-bottom" id="myTabContent">
            
            <div class="tab-pane fade show active" id="lista-pane" role="tabpanel" aria-labelledby="lista-tab" tabindex="0">         
            <form id="ajax-search-form" class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Búsqueda de Empleados
                    </h5>
                </div>
                <div class="card-body" style="background-color: var(--bg-secondary);">
                    <div class="row g-4 align-items-end">
                        <div class="col-md-6">
                            <label for="query" class="form-label">Buscar por RUT o ID SAP</label>
                            <textarea name="query" id="query" rows="3" class="form-control" placeholder="Pega una lista separada por comas, espacios o saltos de línea."></textarea>
                        </div>
                        <div class="col-md-3">
                            <label for="search_by" class="form-label">Campo de Búsqueda</label>
                            <select id="search_by" name="search_by" class="form-select">
                                <option value="rut">RUT</option>
                                <option value="id_sap_local">ID SAP Local</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100" id="search-btn">
                                <i class="fas fa-search me-2"></i>Buscar
                                <div class="spinner-border spinner-border-sm ms-2 d-none" id="search-spinner"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </form>

                <div class="card mb-4">
                    <div class="card-body" style="background-color: var(--bg-secondary);">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <span class="text-muted fw-bold">Selección rápida:</span>
                                    
                                    <button type="button" id="select-all-visible" class="btn btn-outline-primary">
                                        <i class="fas fa-check-square me-2"></i>Seleccionar todos los visibles
                                    </button>
                                    
                                    <button type="button" id="deselect-all" class="btn btn-outline-secondary">
                                        <i class="fas fa-square me-2"></i>Deseleccionar todos
                                    </button>
                                    
                                    <button type="button" id="invert-selection" class="btn btn-outline-info">
                                        <i class="fas fa-exchange-alt me-2"></i>Invertir selección
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <span id="selection-display" class="badge bg-primary fs-6" style="display: none;">
                                    0 empleados seleccionados
                                </span>
                            </div>
                        </div>
                        
                        <div id="selection-message" class="mt-3" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="message-text"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            Resultados
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="bulk-form" action="{{ url_for('editar_masivo') }}" method="post">
                            <input type="hidden" name="query" value="{{ query or '' }}">
                            <input type="hidden" name="search_by" value="{{ search_by or '' }}">
                            
                            <div class="card bg-light border mb-4">
                                <div class="card-body">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label">Acción para empleados seleccionados</label>
                                            <select name="accion" id="accion" class="form-select" required>
                                                <option value="">-- Selecciona una acción --</option>
                                                <optgroup label="Actualizar Campo">
                                                    <option value="area_id">Cambiar Área</option>
                                                    <option value="turno_id">Cambiar Turno</option>
                                                    <option value="status_id">Cambiar Status</option>
                                                    <option value="acreditacion_id">Cambiar Acreditación</option>
                                                    <option value="nomina_id">Cambiar Nómina</option>
                                                    <option value="direccion">Cambiar Dirección</option>
                                                </optgroup>
                                                <optgroup label="Planificar Asistencia">
                                                    <option value="planificar-PRESENTE">PRESENTE</option>
                                                    <option value="planificar-DESCANSO">DESCANSO</option>
                                                    <option value="planificar-FALLA">FALLA</option>
                                                    <option value="planificar-PERMISO_NO_PAGO">PERMISO NO PAGO</option>
                                                    <option value="planificar-PERMISO_PAGO">PERMISO PAGO</option>
                                                    <option value="planificar-POST_NATAL">POST NATAL</option>
                                                    <option value="planificar-VACACIONES">VACACIONES</option>
                                                    <option value="planificar-LICENCIA_MUTUAL">LICENCIA MUTUAL</option>
                                                    <option value="planificar-PERMISO_FALLECIMIENTO">PERMISO X FALLECIMIENTO</option>
                                                    <option value="planificar-LICENCIA_MEDICA">LICENCIA MEDICA</option>
                                                    <option value="planificar-FINIQUITADO">FINIQUITADO</option>
                                                </optgroup>
                                                <optgroup label="Administrar">
                                                    <option value="eliminar" style="color:red; font-weight:bold;">ELIMINAR SELECCIONADOS</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3" id="valor-container" style="display: none;">
                                            <label class="form-label">Nuevo valor</label>
                                            <select name="nuevo_valor_acreditacion_id" id="select_acreditacion_id" class="form-select value-select" style="display: none;">
                                                {% for item in acreditaciones %}
                                                <option value="{{ item.id }}">{{ item.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            <select name="nuevo_valor_nomina_id" id="select_nomina_id" class="form-select value-select" style="display: none;">
                                                {% for item in nominas %}
                                                <option value="{{ item.id }}">{{ item.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            <select name="nuevo_valor_area_id" id="select_area_id" class="form-select value-select" style="display: none;">
                                                {% for item in areas %}
                                                <option value="{{ item.id }}">{{ item.nombre }}</option>
                                                {% endfor %}
                                            </select> 
                                            <select name="nuevo_valor_turno_id" id="select_turno_id" class="form-select value-select" style="display: none;">
                                                {% for item in turnos %}
                                                <option value="{{ item.id }}">{{ item.nombre }}</option>
                                                {% endfor %}
                                            </select> 
                                            <select name="nuevo_valor_status_id" id="select_status_id" class="form-select value-select" style="display: none;">
                                                {% for item in status_empleado %}
                                                <option value="{{ item.id }}">{{ item.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            <input type="text" name="nuevo_valor_direccion" id="input_direccion" class="form-control value-input" placeholder="Ingrese la nueva dirección" style="display: none;">
                                        </div>
                                        
                                        <div class="col-md-3" id="fecha-container" style="display: none;">
                                            <label class="form-label">Período</label>
                                            <div class="d-flex gap-2">
                                                <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" placeholder="Desde">
                                                <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" placeholder="Hasta">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-warning w-100">
                                                <i class="fas fa-bolt me-2"></i>Aplicar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if not is_search_active and total_pages > 1 %}
                            <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded-top border-bottom">
                                <div class="text-muted fs-6">                                    
                                    Mostrando empleados {{ ((page - 1) * 20) + 1 }} - {{ [page * 20, total_empleados]|min }} de {{ total_empleados }} total
                                </div>
                                <nav aria-label="Paginación de empleados">
                                    <ul class="pagination mb-0">
                                        {% if page > 1 %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('index', query=query, search_by=search_by, page=page-1, active_modules=active_modules) }}" aria-label="Anterior">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Anterior">
                                                <span aria-hidden="true">&laquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                        {% for page_num in range([1, page - 2]|max, [total_pages, page + 2]|min + 1) %}
                                            {% if page_num == page %}
                                            <li class="page-item active" aria-current="page">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                            {% else %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('index', query=query, search_by=search_by, page=page_num, active_modules=active_modules) }}">{{ page_num }}</a>
                                            </li>
                                            {% endif %}
                                        {% endfor %}
                                        {% if page < total_pages %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('index', query=query, search_by=search_by, page=page+1, active_modules=active_modules) }}" aria-label="Siguiente">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Siguiente">
                                                <span aria-hidden="true">&raquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                            {% endif %}      
                            
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th width="80">
                                                <div class="form-check">
                                                    <input type="checkbox" id="select-all" class="form-check-input">
                                                </div>
                                            </th>
                                            <th width="150">RUT</th>
                                            <th width="300">Nombre Completo</th>
                                            <th width="120">ID SAP</th>
                                            <th width="150">Teléfono</th>
                                            <th width="200">Cargo</th>
                                            <th width="200">Área</th>
                                            <th width="120">Status</th>
                                            <th width="150" class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for empleado in empleados %}
                                        <tr>
                                            <td>
                                                <div class="form-check">
                                                    <input type="checkbox" name="empleado_ids" value="{{ empleado.id }}" class="employee-checkbox form-check-input" id="checkbox-{{ empleado.id }}">
                                                </div>
                                            </td>
                                            
                                            <td>
                                                <span class="clickable-field" 
                                                      data-checkbox="checkbox-{{ empleado.id }}" 
                                                      title="Clic para seleccionar empleado">
                                                    {{ empleado.rut }}
                                                </span>
                                            </td>
                                            
                                            <td>{{ empleado.nombre_completo }}</td>
                                            
                                            <td>
                                                <span class="badge bg-info-subtle text-info-emphasis clickable-field" 
                                                      data-checkbox="checkbox-{{ empleado.id }}" 
                                                      title="Clic para seleccionar empleado">
                                                    {{ empleado.id_sap_local or 'N/A' }}
                                                </span>
                                            </td>
                                            
                                            <td>{{ empleado.telefono or 'N/A' }}</td>
                                            <td>{{ empleado.cargo_nombre or 'N/A' }}</td>
                                            <td>{{ empleado.area_nombre or 'N/A' }}</td>
                                            <td>
                                                {% if empleado.status_nombre == 'Vigente' %}
                                                    <span class="badge bg-success">{{ empleado.status_nombre }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger">{{ empleado.status_nombre or 'N/A' }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="d-flex gap-2 justify-content-end">
                                                 <a href="/editar/{{ empleado.id }}" 
                                                        class="btn btn-outline-primary btn-sm" 
                                                        title="Editar">
                                                            <i class="fas fa-pencil-alt"></i>
                                                        </a>
                                                    <form action="{{ url_for('eliminar_empleado', id=empleado.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar" 
                                                                onclick="return confirm('¿Estás seguro de que quieres eliminar a este empleado?');">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center text-muted p-5">
                                                <div class="py-4">
                                                    <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                                                    <h5>No se encontraron empleados</h5>
                                                    <p>Intenta ajustar los criterios de búsqueda</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            {% if is_search_active %}
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-search me-2"></i>
                                <strong>Búsqueda activa:</strong> Mostrando todos los {{ total_empleados }} resultados encontrados para "{{ query }}"
                                {% if total_empleados > 0 %}
                                <br><small class="text-muted">Consejo: Haz clic en el RUT o ID SAP para seleccionar empleados rápidamente</small>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade p-4 text-center" id="registrar-pane" role="tabpanel" aria-labelledby="registrar-tab" tabindex="0">
                <div class="py-5 my-5">
                    <h5 class="mb-4">
                        <i class="fas fa-user-plus fa-2x mb-3 text-secondary"></i>
                        <br>
                        Agregar un Nuevo Empleado
                    </h5>
                    <p class="text-muted">Utilice el formulario avanzado para registrar un nuevo empleado de forma guiada.</p>
                    <button type="button" class="btn btn-success btn-lg" id="new-employee-modal-btn">
                        <i class="fas fa-user-plus me-2"></i>Abrir Formulario de Registro
                    </button>
                </div>
            </div>
            
<div class="tab-pane fade p-4" id="herramientas-pane" role="tabpanel" aria-labelledby="herramientas-tab" tabindex="0">
    
    <div class="upload-section">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Carga Masiva de Empleados
                </h5>
            </div>
            <div class="card-body p-4">
                
                <div class="dropzone-container">
                    <div class="dropzone" id="file-dropzone">
                        <div class="dropzone-content" id="dropzone-content">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4 class="upload-title">Arrastra tu archivo aquí</h4>
                            <p class="upload-description">
                                o <button type="button" class="btn-link" id="browse-files">haz clic para seleccionar</button>
                            </p>
                            <div class="upload-info">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Formatos soportados: Excel (.xlsx, .xls), CSV (.csv) - Máximo 10MB
                                </small>
                            </div>
                        </div>
                        
                        <div class="file-preview d-none" id="file-preview">
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-file-excel text-success"></i>
                            </div>
                            <div class="file-details">
                                <h6 class="file-name" id="file-name">archivo.xlsx</h6>
                                <p class="file-size text-muted" id="file-size">0 KB</p>
                            </div>
                            <div class="file-actions">
                                <button type="button" class="btn btn-success btn-sm" id="upload-btn">
                                    <i class="fas fa-upload me-1"></i>Subir
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="remove-file">
                                    <i class="fas fa-trash me-1"></i>Quitar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="file" 
                       id="file-input" 
                       accept=".xlsx,.xls,.csv" 
                       style="display: none;"
                       name="archivo_excel">
                
                <div class="upload-options mt-4" id="upload-options">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="validate-data" checked>
                                <label class="form-check-label" for="validate-data">
                                    <i class="fas fa-check-circle text-success me-1"></i>
                                    Validar datos antes de importar
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="skip-duplicates" checked>
                                <label class="form-check-label" for="skip-duplicates">
                                    <i class="fas fa-filter text-info me-1"></i>
                                    Saltar duplicados automáticamente
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="send-notifications">
                                <label class="form-check-label" for="send-notifications">
                                    <i class="fas fa-bell text-warning me-1"></i>
                                    Notificar por email al completar
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="create-backup" checked>
                                <label class="form-check-label" for="create-backup">
                                    <i class="fas fa-save text-primary me-1"></i>
                                    Crear respaldo antes de importar
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="template-section mt-4">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-download text-info me-3" style="font-size: 1.5rem;"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">¿Primera vez usando carga masiva?</h6>
                            <p class="mb-2">Descarga nuestra plantilla con las columnas correctas y ejemplos.</p>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-info btn-sm" id="download-template">
                                    <i class="fas fa-file-excel me-1"></i>Descargar Plantilla Excel
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="view-instructions">
                                    <i class="fas fa-question-circle me-1"></i>Ver Instrucciones
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="upload-results d-none" id="upload-results">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="fas fa-check-circle me-2"></i>Carga Completada
                        </h6>
                        <div class="results-summary" id="results-summary">
                            </div>
                        <hr>
                        <div class="results-actions">
                            <button type="button" class="btn btn-success btn-sm" id="view-imported">
                                <i class="fas fa-eye me-1"></i>Ver Empleados Importados
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" id="download-report">
                                <i class="fas fa-download me-1"></i>Descargar Reporte
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="validation-errors d-none" id="validation-errors">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Se encontraron errores de validación
                        </h6>
                        <div class="errors-list" id="errors-list">
                            </div>
                        <hr>
                        <div class="error-actions">
                            <button type="button" class="btn btn-warning btn-sm" id="download-errors">
                                <i class="fas fa-file-excel me-1"></i>Descargar Errores
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" id="fix-and-retry">
                                <i class="fas fa-redo me-1"></i>Corregir y Reintentar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mt-4">
            <div class="card border-danger-subtle">
                <div class="card-header text-danger">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-slash me-2"></i>Actualización de Desvinculaciones
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text text-muted">Sube un Excel con rut, id_sap_local, fecha_egreso y causal_despido_id para procesar finiquitos.</p>
                    <form action="{{ url_for('upload_desvinculaciones') }}" method="post" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="file" class="form-control" name="archivo_excel" accept=".xlsx" required>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-arrow-right-from-bracket me-2"></i>Procesar Desvinculaciones
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mt-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-magic me-2 text-primary"></i>Importación Inteligente
                    </h5>
                    <p class="card-text text-muted">
                        Validación en tiempo real, corrección automática y vista previa avanzada.
                    </p>
                    <button type="button" class="btn btn-success" id="open-real-time-import-modal">
                        <i class="fas fa-file-import me-1"></i>Importar Archivo
                    </button>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#batchUpdateModal">
                        <i class="fas fa-pen-to-square me-1"></i>Actualización por Lotes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="instructionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-book me-2"></i>Instrucciones de Carga Masiva
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="instruction-step">
                        <h6><i class="fas fa-download text-success me-2"></i>Paso 1: Descarga la Plantilla</h6>
                        <p>Descarga la plantilla Excel que contiene todas las columnas necesarias con ejemplos.</p>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-edit text-info me-2"></i>Paso 2: Completa los Datos</h6>
                        <p>Llena la plantilla con los datos de tus empleados. Columnas obligatorias:</p>
                        <ul class="list-unstyled ps-4">
                            <li><i class="fas fa-check text-success me-2"></i>RUT (formato: 12345678-9)</li>
                            <li><i class="fas fa-check text-success me-2"></i>Nombre Completo</li>
                            <li><i class="fas fa-check text-success me-2"></i>Fecha de Ingreso (formato: DD/MM/AAAA)</li>
                            <li><i class="fas fa-check text-success me-2"></i>Cargo</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-upload text-warning me-2"></i>Paso 3: Sube el Archivo</h6>
                        <p>Arrastra tu archivo completado al área de carga o haz clic para seleccionarlo.</p>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-cogs text-primary me-2"></i>Paso 4: Configura las Opciones</h6>
                        <p>Selecciona las opciones de validación y procesamiento según tus necesidades.</p>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading">Consejos Importantes:</h6>
                        <ul class="mb-0">
                            <li>Asegúrate de que los RUTs estén en formato chileno válido</li>
                            <li>Las fechas deben estar en formato DD/MM/AAAA</li>
                            <li>Los cargos, áreas y turnos deben existir previamente en el sistema</li>
                            <li>Revisa que no haya espacios extra en los datos</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="download-template-modal">
                        <i class="fas fa-download me-1"></i>Descargar Plantilla
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="employeeModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <div class="modal-title-container">
                    <h4 class="modal-title" id="employeeModalTitle">
                        <i class="fas fa-user-plus me-2"></i>Agregar Nuevo Empleado
                    </h4>
                    <p class="modal-subtitle mb-0" id="employeeModalSubtitle">
                        Complete toda la información requerida del empleado
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline-light btn-sm" id="modal-help-btn">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>

            <div class="modal-progress">
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar bg-success" id="form-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="modal-body">
                <div class="step-navigation">
                    <div class="steps-container">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Información Personal</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Información Laboral</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Asignaciones</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Revisión</div>
                        </div>
                    </div>
                </div>

                <form id="employeeForm" class="multi-step-form">
                    <div class="step-content active" data-step="1">
                        <div class="step-header">
                            <h5><i class="fas fa-user me-2 text-primary"></i>Información Personal</h5>
                            <p class="text-muted">Datos básicos y personales del empleado</p>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">RUT</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="rut" 
                                       id="rut"
                                       placeholder="12345678-9" 
                                       data-validation="rut">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Nombre Completo</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="nombre_completo" 
                                       id="nombre_completo"
                                       placeholder="Nombres y Apellidos"
                                       data-validation="required">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Fecha de Nacimiento</label>
                                <input type="date" 
                                       class="form-control" 
                                       name="fecha_nacimiento" 
                                       id="fecha_nacimiento"
                                       data-validation="date">
                                <div class="form-feedback"></div>
                                <small class="age-display text-muted"></small>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" 
                                       class="form-control" 
                                       name="telefono" 
                                       id="telefono"
                                       placeholder="+56 9 1234 5678"
                                       data-validation="phone">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email" 
                                       class="form-control" 
                                       name="correo_electronico" 
                                       id="correo_electronico"
                                       placeholder="empleado@empresa.com"
                                       data-validation="email">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-8">
                                <label class="form-label">Dirección</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="direccion" 
                                       id="direccion"
                                       placeholder="Dirección completa">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label required">Región</label>
                                <select class="form-select" 
                                        name="region_id" 
                                        id="region_id"
                                        data-validation="required">
                                    <option value="">-- Seleccione Región --</option>
                                    {% for region in regiones %}
                                    <option value="{{ region.id }}">{{ region.region }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Comuna</label>
                                <select class="form-select" 
                                        name="comuna_id" 
                                        id="comuna_id"
                                        data-validation="required" 
                                        disabled>
                                    <option value="">-- Primero elija una región --</option>
                                </select>
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="genero_id" class="form-label">Género</label>
                                <select class="form-select" id="genero_id" name="genero_id" required>
                                    <option value="">Seleccione...</option>
                                    {% for genero in generos %}
                                        <option value="{{ genero['id'] }}">{{ genero['nombre'] }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="nacionalidad_id" class="form-label">Nacionalidad</label>
                                <select class="form-select" id="nacionalidad_id" name="nacionalidad_id" required>
                                    <option value="">Seleccione...</option>
                                    {% for n in nacionalidades %}
                                        <option value="{{ n['id'] }}">{{ n['pais'] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="step-content" data-step="2">
                        <div class="step-header">
                            <h5><i class="fas fa-briefcase me-2 text-success"></i>Información Laboral</h5>
                            <p class="text-muted">Detalles contractuales y laborales</p>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="id_sap_local" class="form-label">ID SAP Local</label>
                                <input type="text" class="form-control" id="id_sap_local" name="id_sap_local">
                            </div>

                            <div class="col-md-4">
                                <label for="id_sap_global" class="form-label">ID SAP Global</label>
                                <input type="text" class="form-control" id="id_sap_global" name="id_sap_global">
                            </div>

                            <div class="col-md-4">
                                <label for="fecha_ingreso" class="form-label">Fecha de Ingreso <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" required>
                            </div>

                            <div class="col-md-6">
                                <label for="tipo_contrato_id" class="form-label">Tipo de Contrato</label>
                                <select class="form-select" id="tipo_contrato_id" name="tipo_contrato_id" required>
                                    <option value="">Seleccione...</option>
                                    {% for t in tipos_contrato %}
                                        <option value="{{ t['id'] }}">{{ t['nombre'] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6" id="campo-vencimiento">
                                <label class="form-label">Fecha Vencimiento</label>
                                <input type="date" 
                                       class="form-control" 
                                       name="fecha_vencimiento_contrato" 
                                       id="fecha_vencimiento_contrato">
                                <div class="form-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <div class="contract-preview alert alert-info d-none" id="contract-preview">
                                    <h6><i class="fas fa-file-contract me-2"></i>Vista Previa del Contrato</h6>
                                    <div class="contract-details"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step-content" data-step="3">
                        <div class="step-header">
                            <h5><i class="fas fa-sitemap me-2 text-warning"></i>Asignaciones Organizacionales</h5>
                            <p class="text-muted">Cargo, área, turno y otras asignaciones</p>
                        </div>
                        
                        <div class="row g-3">
    <div class="col-md-6">
        <label class="form-label required">Cargo</label>
        <select class="form-select" name="cargo_id" id="cargo_id" data-validation="required">
            <option value="">-- Seleccione Cargo --</option>
            {% for cargo in cargos %}
            <option value="{{ cargo.id }}">{{ cargo.nombre }}</option>
            {% endfor %}
        </select>
        <div class="form-feedback"></div>
    </div>
    
    <div class="col-md-6">
        <label class="form-label">Área</label>
        <select class="form-select" name="area_id" id="area_id">
            <option value="">-- Seleccione Área --</option>
            {% for item in areas %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
        <div class="form-feedback"></div>
    </div>
    
    <div class="col-md-6">
        <label class="form-label required">Turno</label>
        <select class="form-select" name="turno_id" id="turno_id" data-validation="required">
            <option value="">-- Seleccione Turno --</option>
            {% for turno in turnos %}
            <option value="{{ turno.id }}">{{ turno.nombre }}</option>
            {% endfor %}
        </select>
        <div class="form-feedback"></div>
    </div>
    
    <div class="col-md-6">
        <label class="form-label">Supervisión</label>
        <select class="form-select" name="supervision_id" id="supervision_id">
            <option value="">-- Seleccione Supervisión --</option>
            {% for item in supervisiones %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
        <div class="form-feedback"></div>
    </div>
    
    <div class="col-md-6">
        <label class="form-label">Nómina</label>
        <select class="form-select" name="nomina_id" id="nomina_id">
            <option value="">-- Seleccione Nómina --</option>
            {% for item in nominas %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Acreditación</label>
        <select class="form-select" name="acreditacion_id" id="acreditacion_id">
            <option value="">-- Seleccione Acreditación --</option>
            {% for item in acreditaciones %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Distribución de Categoría</label>
        <select class="form-select" name="distribucion_categoria_id" id="distribucion_categoria_id">
            <option value="">-- Seleccione Distribución --</option>
            {% for item in distribucion_categorias %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Tipo de Pasaje</label>
        <select class="form-select" name="tipo_pasaje_id" id="tipo_pasaje_id">
            <option value="">-- Seleccione Tipo de Pasaje --</option>
            {% for item in tipos_pasaje %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Fase</label>
        <select class="form-select" name="fase_id" id="fase_id">
            <option value="">-- Seleccione Fase --</option>
            {% for item in fases %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-4">
        <label class="form-label">Relación Laboral</label>
        <select class="form-select" name="relacion_laboral_id" id="relacion_laboral_id">
            <option value="">-- Seleccione --</option>
            {% for item in relaciones_laborales %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-4">
        <label class="form-label">Status</label>
        <select class="form-select" name="status_id" id="status_id">
            <option value="">-- Seleccione Status --</option>
            {% for item in status_empleado %}
            <option value="{{ item.id }}">{{ item.nombre }}</option>
            {% endfor %}
        </select>
    </div>
</div>
                        
                        <div class="org-preview mt-4">
                            <h6><i class="fas fa-chart-line me-2"></i>Vista Previa Organizacional</h6>
                            <div class="org-chart" id="org-chart">
                            </div>
                        </div>
                    </div>

                    <div class="step-content" data-step="4">
                        <div class="step-header">
                            <h5><i class="fas fa-check-circle me-2 text-info"></i>Revisión Final</h5>
                            <p class="text-muted">Verifique toda la información antes de guardar</p>
                        </div>
                        
                        <div class="review-section">
                            <div class="review-cards">
                            </div>
                            
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="confirm-data">
                                <label class="form-check-label" for="confirm-data">
                                    <strong>Confirmo que toda la información es correcta</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="footer-content">
                    <div class="validation-summary" id="validation-summary">
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="prev-step" style="display: none;">
                            <i class="fas fa-chevron-left me-1"></i>Anterior
                        </button>
                        <button type="button" class="btn btn-primary" id="next-step">
                            Siguiente<i class="fas fa-chevron-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submit-form" style="display: none;">
                            <i class="fas fa-save me-1"></i>Guardar Empleado
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<div class="modal fade" id="realTimeImportModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-import text-white">
                <div class="import-header-info">
                    <h4 class="modal-title">
                        <i class="fas fa-file-import me-2"></i>Importación Inteligente
                    </h4>
                    <p class="mb-0">Validación en tiempo real con vista previa y corrección automática</p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="import-progress-steps">
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title">Seleccionar Archivo</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title">Validar Datos</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title">Corregir Errores</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-title">Importar</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="import-step active" data-step="1">
                    <div class="file-upload-advanced">
                        <div class="upload-options mb-4">
                            <h6><i class="fas fa-cog me-2"></i>Configuración de Importación</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Modo de Validación</label>
                                    <select class="form-select" id="validation-mode">
                                        <option value="strict">Estricto (Rechazar errores)</option>
                                        <option value="permissive" selected>Permisivo (Corregir automáticamente)</option>
                                        <option value="interactive">Interactivo (Preguntar por cada error)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Manejo de Duplicados</label>
                                    <select class="form-select" id="duplicate-handling">
                                        <option value="skip">Saltar duplicados</option>
                                        <option value="update" selected>Actualizar existentes</option>
                                        <option value="create">Crear como nuevos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Procesamiento</label>
                                    <select class="form-select" id="processing-mode">
                                        <option value="batch" selected>Por lotes (Rápido)</option>
                                        <option value="real-time">Tiempo real (Detallado)</option>
                                        <option value="background">En segundo plano</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="drag-drop-zone" id="advanced-dropzone">
                            <div class="drop-content">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h5>Arrastra tu archivo Excel o CSV</h5>
                                <p class="text-muted">o <button type="button" class="btn-link" id="browse-advanced">selecciona desde tu computador</button></p>
                                <div class="supported-formats">
                                    <small class="text-muted">
                                        <i class="fas fa-check text-success me-1"></i>Excel (.xlsx, .xls)
                                        <i class="fas fa-check text-success me-1 ms-3"></i>CSV (.csv)
                                        <i class="fas fa-check text-success me-1 ms-3"></i>Hasta 100MB
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <input type="file" id="advanced-file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                
                <div class="import-step" data-step="2" style="display: none;">
                    <div class="validation-progress">
                        <div class="progress-header d-flex justify-content-between align-items-center">
                            <h6><i class="fas fa-cogs me-2"></i>Validando Datos en Tiempo Real</h6>
                            <div class="validation-stats">
                                <span class="stat-item">
                                    <i class="fas fa-file-alt text-primary"></i>
                                    <span id="total-rows">0</span> filas
                                </span>
                                <span class="stat-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span id="valid-rows">0</span> válidas
                                </span>
                                <span class="stat-item">
                                    <i class="fas fa-times text-danger"></i>
                                    <span id="error-rows">0</span> errores
                                </span>
                            </div>
                        </div>
                        
                        <div class="progress mb-3">
                            <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                 id="validation-progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="validation-details" style="max-height: 150px; overflow-y: auto;">
                            <div class="validation-log" id="validation-log">
                                </div>
                        </div>
                    </div>
                    
                    <div class="data-preview mt-4">
                        <h6><i class="fas fa-table me-2"></i>Vista Previa de Datos</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm table-hover" id="preview-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="import-step" data-step="3" style="display: none;">
                     <div class="error-correction">
                        <div class="correction-header d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-wrench me-2"></i>Corregir Errores Encontrados (<span id="error-count-header">0</span>)</h6>
                            <div class="correction-actions">
                                <button class="btn btn-success btn-sm" id="auto-fix-all">
                                    <i class="fas fa-magic me-1"></i>Corrección Automática
                                </button>
                                <button class="btn btn-info btn-sm" id="export-errors">
                                    <i class="fas fa-download me-1"></i>Exportar Errores
                                </button>
                            </div>
                        </div>
                        
                        <div class="errors-container" id="errors-container" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-center text-muted">No se han encontrado errores o ya fueron corregidos.</p>
                        </div>
                    </div>
                </div>
                
                <div class="import-step" data-step="4" style="display: none;">
                    <div class="final-import text-center">
                        <div class="import-summary">
                            <i class="fas fa-clipboard-check text-success" style="font-size: 4rem;"></i>
                            <h4 class="mt-3">Listo para Importar</h4>
                            <p class="text-muted">Se importarán los siguientes registros. Confirme para continuar.</p>
                            
                            <div class="summary-cards">
                                <div class="summary-card success">
                                    <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                                    <div class="card-info">
                                        <div class="card-number" id="final-valid">0</div>
                                        <div class="card-label">Registros a Importar</div>
                                    </div>
                                </div>
                                <div class="summary-card info">
                                    <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
                                    <div class="card-info">
                                        <div class="card-number" id="final-new">0</div>
                                        <div class="card-label">Nuevos Empleados</div>
                                    </div>
                                </div>
                                <div class="summary-card warning">
                                    <div class="card-icon"><i class="fas fa-edit"></i></div>
                                    <div class="card-info">
                                        <div class="card-number" id="final-updates">0</div>
                                        <div class="card-label">Empleados a Actualizar</div>
                                    </div>
                                </div>
                                 <div class="summary-card danger">
                                    <div class="card-icon"><i class="fas fa-times-circle"></i></div>
                                    <div class="card-info">
                                        <div class="card-number" id="final-skipped">0</div>
                                        <div class="card-label">Registros Saltados</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="footer-left">
                    <div class="import-status text-muted" id="import-status">
                        Seleccione un archivo para comenzar
                    </div>
                </div>
                
                <div class="footer-right">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="prev-import-step" style="display: none;">
                        <i class="fas fa-arrow-left me-1"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-primary" id="next-import-step" disabled>
                        Siguiente<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="start-import" style="display: none;">
                        <i class="fas fa-play me-1"></i>Iniciar Importación
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="import-animation mb-4">
                    <div class="spinner-container">
                        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
                        <div class="spinner-inner">
                            <i class="fas fa-database text-primary"></i>
                        </div>
                    </div>
                </div>
                
                <h4 class="import-title" id="import-progress-title">Importando Datos...</h4>
                <p class="import-message text-muted" id="import-progress-message">
                    Por favor espere mientras procesamos los datos
                </p>
                
                <div class="progress-detailed mb-3">
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             id="import-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <small class="text-muted">
                            <span id="current-record">0</span> de <span id="total-records">0</span> registros procesados
                        </small>
                    </div>
                </div>
                
                <div class="live-updates" id="live-updates">
                    <div class="update-line">Iniciando proceso...</div>
                </div>
                
                <button class="btn btn-outline-danger btn-sm mt-3" id="cancel-import" style="display: none;">
                    <i class="fas fa-stop me-1"></i>Cancelar Importación
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="batchUpdateModal" tabindex="-1" aria-labelledby="batchUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="batchUpdateModalLabel">
                    <i class="fas fa-pen-to-square me-2"></i>Actualización Masiva por Lotes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Instrucciones:</strong> Copia y pega desde una hoja de cálculo. Cada línea debe contener el identificador del empleado y el nuevo valor, separados por coma, tabulación o punto y coma.
                </div>
                
                <form id="batch-update-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="identifier_field" class="form-label">Identificar empleado por:</label>
                            <select id="identifier_field" class="form-select">
                                <option value="rut" selected>RUT</option>
                                <option value="id_sap_local">ID SAP Local</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="update_field" class="form-label">Campo a actualizar:</label>
                            <select id="update_field" class="form-select">
                                <option value="direccion" selected>Dirección</option>
                                <option value="telefono">Teléfono</option>
                                <option value="correo_electronico">Correo Electrónico</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="batch_data" class="form-label">Pega tus datos aquí (Ej: 12345678-9, Nueva Avenida 456):</label>
                            <textarea id="batch_data" class="form-control" rows="10" placeholder="11111111-1, Calle Falsa 123&#10;22222222-2, Avenida Siempre Viva 742"></textarea>
                        </div>
                    </div>
                </form>

                <div id="batch-update-results" class="mt-4" style="display: none;">
                    <h5>Resultados</h5>
                    <div class="alert" id="batch-update-alert"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="process-batch-update-btn">
                    <span id="process-btn-text">
                        <i class="fas fa-bolt me-2"></i>Procesar Actualización
                    </span>
                    <span id="process-btn-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ============================================
// SISTEMA DE GESTIÓN DE EMPLEADOS - CÓDIGO CORREGIDO Y RESTAURADO
// ============================================

// ============================================
// SISTEMA DE TEMA OSCURO/CLARO
// ============================================
function toggleTheme() {
    try {
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        
        if (!body || !themeIcon) {
            console.error('Theme elements not found');
            return;
        }
        
        const currentTheme = body.getAttribute('data-bs-theme') || 'light';
        
        if (currentTheme === 'light') {
            body.setAttribute('data-bs-theme', 'dark');
            themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme', 'dark');
        } else {
            body.setAttribute('data-bs-theme', 'light');
            themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme', 'light');
        }
    } catch (error) {
        console.error('Error in toggleTheme:', error);
    }
}

// ============================================
// SISTEMA DE NOTIFICACIONES TOAST
// ============================================
function showToast(message, type = 'info', duration = 4000) {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        console.log(`Toast ${type}: ${message}`);
        return;
    }

    const toastId = 'toast-' + Date.now();
    const iconMap = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };

    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast-notification toast-${type}`;
    
    toast.innerHTML = `
        <div class="toast-content d-flex align-items-center">
            <i class="${iconMap[type] || iconMap.info} me-2"></i>
            <span>${message}</span>
        </div>
        <button class="btn-close btn-sm" onclick="removeToast('${toastId}')"></button>
    `;

    toastContainer.appendChild(toast);

    setTimeout(() => {
        removeToast(toastId);
    }, duration);
}

function removeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }
}

// ============================================
// GESTOR DE ENVÍO DE FORMULARIOS (EVITA DUPLICADOS)
// ============================================
class FormSubmitManager {
    constructor() {
        this.submitting = false;
        this.submitQueue = new Map();
    }
    
    async submitForm(url, formData, identifier = 'default') {
        if (this.submitQueue.has(identifier)) {
            showToast('Procesando solicitud anterior...', 'warning');
            return this.submitQueue.get(identifier);
        }
        
        const submitPromise = this._performSubmit(url, formData);
        this.submitQueue.set(identifier, submitPromise);
        
        try {
            return await submitPromise;
        } finally {
            this.submitQueue.delete(identifier);
        }
    }
    
    async _performSubmit(url, formData) {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        // CORRECCIÓN: Devolver el JSON incluso si hay error para leer el mensaje
        const data = await response.json();

        if (!response.ok) {
            // Lanza un error que contiene el mensaje del servidor
            const error = new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
            error.response = response;
            throw error;
        }
        
        return data;
    }
}

// ============================================
// MODAL AVANZADO PARA EMPLEADOS (CREAR Y EDITAR) - RESTAURADO
// ============================================
class AdvancedEmployeeModal {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 4;
        this.formData = {};
        this.validationErrors = {};
        this.isEditing = false;
        this.editingId = null;
        this.formSubmitManager = new FormSubmitManager();
        this._eventHandlers = new Map();

        this.initElements();
        this.bindEvents();
    }

    initElements() {
        this.modal = document.getElementById('employeeModal');
        this.modalTitle = document.getElementById('employeeModalTitle');
        this.modalSubtitle = document.getElementById('employeeModalSubtitle');
        this.form = document.getElementById('employeeForm');
        this.progressBar = document.getElementById('form-progress');
        this.nextBtn = document.getElementById('next-step');
        this.prevBtn = document.getElementById('prev-step');
        this.submitBtn = document.getElementById('submit-form');
        this.validationSummary = document.getElementById('validation-summary');

        if (this.modal) {
            this.bsModal = new bootstrap.Modal(this.modal, {
                backdrop: 'static',
                keyboard: false
            });
        }
    }

    bindEvents() {
        if (this.nextBtn) this.nextBtn.addEventListener('click', (e) => { e.preventDefault(); this.nextStep(); });
        if (this.prevBtn) this.prevBtn.addEventListener('click', (e) => { e.preventDefault(); this.prevStep(); });
        if (this.submitBtn) this.submitBtn.addEventListener('click', (e) => { e.preventDefault(); this.submitForm(); });
        if (this.form) {
            this.form.addEventListener('input', (e) => this.validateField(e.target));
            this.form.addEventListener('change', (e) => this.validateField(e.target));
        }
        document.getElementById('rut')?.addEventListener('blur', () => this.validateRutOnBlur());
        document.getElementById('region_id')?.addEventListener('change', () => this.loadComunas());
        document.getElementById('tipo_contrato_id')?.addEventListener('change', () => this.toggleContractFields());
        document.getElementById('fecha_nacimiento')?.addEventListener('change', () => this.calculateAge());
        document.querySelectorAll('.step').forEach(step => {
            step.addEventListener('click', () => this.goToStep(parseInt(step.dataset.step)));
        });
        if (this.modal) this.modal.addEventListener('hidden.bs.modal', () => this.resetModal());
    }

    async validateRutOnBlur() {
        const rutInput = document.getElementById('rut');
        if (!rutInput) return;

        const feedbackEl = rutInput.parentElement.querySelector('.form-feedback');
        const rutValue = rutInput.value.trim();

        if (!rutValue) {
            rutInput.classList.remove('is-valid', 'is-invalid');
            if(feedbackEl) feedbackEl.textContent = '';
            return;
        }

        rutInput.classList.remove('is-valid', 'is-invalid');
        if(feedbackEl) {
            feedbackEl.textContent = 'Validando RUT...';
            feedbackEl.style.color = 'var(--text-secondary)';
        }

        try {
            const response = await fetch('/api/validate-rut', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rut: rutValue })
            });

            const data = await response.json();
            
            if (data.exists || !data.valid) {
                rutInput.classList.add('is-invalid');
                rutInput.classList.remove('is-valid');
                if(feedbackEl) {
                    feedbackEl.textContent = data.message;
                    feedbackEl.style.color = 'var(--danger-color)';
                }
            } else {
                rutInput.classList.add('is-valid');
                rutInput.classList.remove('is-invalid');
                 if(feedbackEl) {
                    feedbackEl.textContent = data.message;
                    feedbackEl.style.color = 'var(--success-color)';
                }
            }
        } catch (error) {
            rutInput.classList.add('is-invalid');
            if(feedbackEl) {
                feedbackEl.textContent = 'No se pudo validar el RUT. Verifique su conexión.';
                feedbackEl.style.color = 'var(--danger-color)';
            }
        }
    }

    async loadComunas() {
        const regionId = document.getElementById('region_id').value;
        const comunaSelect = document.getElementById('comuna_id');
        
        if (!regionId) {
            comunaSelect.innerHTML = '<option value="">-- Primero elija una región --</option>';
            comunaSelect.disabled = true;
            return;
        }
        
        try {
            const response = await fetch(`/get_comunas/${regionId}`);
            if (response.ok) {
                const comunas = await response.json();
                let optionsHtml = '<option value="">-- Seleccione Comuna --</option>';
                comunas.forEach(comuna => {
                    optionsHtml += `<option value="${comuna.id}">${comuna.nombre}</option>`;
                });
                comunaSelect.innerHTML = optionsHtml;
                comunaSelect.disabled = false;
            } else {
                throw new Error('Error al cargar comunas');
            }
        } catch (error) {
            console.error('Error loading comunas:', error);
            comunaSelect.innerHTML = '<option value="">-- Error al cargar comunas --</option>';
            comunaSelect.disabled = true;
        }
    }

    async openForEdit(employeeId) {
        this.isEditing = true;
        this.editingId = employeeId;
        
        try {
            showToast('Cargando datos del empleado...', 'info');
            const response = await fetch(`/api/employee/${employeeId}`);
            if (!response.ok) throw new Error('Error al cargar datos del empleado');
            const employeeData = await response.json();
            
            if (this.modalTitle) this.modalTitle.innerHTML = `<i class="fas fa-user-edit me-2"></i>Editar Empleado`;
            if (this.modalSubtitle) this.modalSubtitle.textContent = `Modificando datos de ${employeeData.nombre_completo}`;
            await this.populateForm(employeeData);
            if (this.bsModal) this.bsModal.show();
            showToast('Datos cargados correctamente', 'success');
        } catch (error) {
            console.error('Error abriendo modal de edición:', error);
            showToast('Error al cargar los datos del empleado', 'error');
        }
    }

    async populateForm(employeeData) {
        if (!employeeData || !this.form) return;
        Object.keys(employeeData).forEach(key => {
            const input = this.form.querySelector(`[name="${key}"]`);
            if (input && employeeData[key] !== null) input.value = employeeData[key];
        });
        this.goToStep(1);
        if (employeeData.region_id) {
            await this.loadComunas();
            if (employeeData.comuna_id) await this.waitForOption('comuna_id', employeeData.comuna_id);
        }
        if (employeeData.fecha_nacimiento) this.calculateAge();
        if (employeeData.tipo_contrato_id) this.toggleContractFields();
        this.updateReviewSection();
    }

    async waitForOption(selectId, value, maxAttempts = 30) {
        const select = document.getElementById(selectId);
        if (!select) return;
        for (let i = 0; i < maxAttempts; i++) {
            if (select.querySelector(`option[value="${value}"]`)) {
                select.value = value;
                return;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }
    }

    openForNew() {
        this.isEditing = false;
        this.editingId = null;
        if (this.modalTitle) this.modalTitle.innerHTML = '<i class="fas fa-user-plus me-2"></i>Agregar Nuevo Empleado';
        if (this.modalSubtitle) this.modalSubtitle.textContent = 'Complete toda la información requerida del empleado';
        this.resetModal();
        if (this.bsModal) this.bsModal.show();
    }

    nextStep() {
        if (this.validateCurrentStep()) {
            if (this.currentStep < this.totalSteps) this.goToStep(this.currentStep + 1);
        }
    }

    prevStep() {
        if (this.currentStep > 1) this.goToStep(this.currentStep - 1);
    }

    goToStep(stepNum) {
        if (stepNum < this.currentStep || this.validateStepsUpTo(stepNum - 1)) {
            this.currentStep = stepNum;
            this.updateStepDisplay();
        }
    }

    validateStepsUpTo(targetStep) {
        for (let i = 1; i <= targetStep; i++) {
            const isValid = [...document.querySelectorAll(`.step-content[data-step="${i}"] [data-validation="required"]`)]
                .every(field => this.validateField(field));
            if (!isValid) {
                showToast(`Por favor complete los campos requeridos en el paso ${i}`, 'warning');
                return false;
            }
        }
        return true;
    }

    updateStepDisplay() {
        document.querySelectorAll('.step-content').forEach(c => c.style.display = 'none');
        document.querySelector(`.step-content[data-step="${this.currentStep}"]`).style.display = 'block';
        document.querySelectorAll('.step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            step.classList.toggle('active', stepNum === this.currentStep);
            step.classList.toggle('completed', stepNum < this.currentStep);
        });
        const progress = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
        if (this.progressBar) this.progressBar.style.width = `${progress}%`;
        if (this.prevBtn) this.prevBtn.style.display = this.currentStep > 1 ? 'block' : 'none';
        if (this.nextBtn) this.nextBtn.style.display = this.currentStep < this.totalSteps ? 'block' : 'none';
        if (this.submitBtn) {
            this.submitBtn.style.display = this.currentStep === this.totalSteps ? 'block' : 'none';
            this.submitBtn.innerHTML = this.isEditing ? '<i class="fas fa-save me-1"></i>Actualizar' : '<i class="fas fa-save me-1"></i>Guardar';
        }
        if (this.currentStep === 4) this.updateReviewSection();
    }

    validateCurrentStep() {
        const fields = document.querySelectorAll(`.step-content[data-step="${this.currentStep}"] [data-validation]`);
        let isValid = true;
        fields.forEach(field => { if (!this.validateField(field)) isValid = false; });
        if (!isValid) showToast('Por favor complete todos los campos requeridos', 'warning');
        return isValid;
    }

    validateField(field) {
        if (!field || !field.dataset.validation) return true;
        const validation = field.dataset.validation;
        const value = field.value.trim();
        let isValid = true;
        let message = '';
        const feedback = field.parentElement.querySelector('.form-feedback');
        
        switch (validation) {
            case 'required': isValid = value !== ''; message = 'Campo requerido'; break;
            case 'rut': isValid = value === '' || this.validateRutFormat(value); message = 'Formato de RUT inválido'; break;
            case 'email': isValid = value === '' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value); message = 'Email inválido'; break;
            case 'phone': isValid = value === '' || /^(\+?56)?[\s\-]?[2-9]\d{7,8}$/.test(value.replace(/\s/g, '')); message = 'Teléfono inválido'; break;
            case 'date': isValid = value === '' || !isNaN(Date.parse(value)); message = 'Fecha inválida'; break;
        }

        field.classList.toggle('is-valid', isValid && value !== '' && validation);
        field.classList.toggle('is-invalid', !isValid && validation);
        if (feedback) feedback.textContent = isValid ? '' : message;
        return isValid;
    }
    
    // ==========================================================
    // =====> INICIO DE LA CORRECCIÓN: ALGORITMO DE RUT CORRECTO
    // ==========================================================
    validateRutFormat(rut) {
        if (!rut || typeof rut !== 'string') return false;
        
        const cleanRut = rut.replace(/[^0-9kK]/g, '').toUpperCase();
        if (cleanRut.length < 2) return false;
        
        const body = cleanRut.slice(0, -1);
        const dv = cleanRut.slice(-1);
        
        if(!/^\d+$/.test(body)) return false;

        let sum = 0;
        let multiplier = 2;
        for (let i = body.length - 1; i >= 0; i--) {
            sum += parseInt(body[i]) * multiplier;
            multiplier = multiplier === 7 ? 2 : multiplier + 1;
        }
        const calculatedDvRaw = 11 - (sum % 11);
        
        if (calculatedDvRaw == 11) return dv == '0';
        if (calculatedDvRaw == 10) return dv == 'K';
        return dv == calculatedDvRaw.toString();
    }
    // ==========================================================
    // =====> FIN DE LA CORRECCIÓN
    // ==========================================================

    toggleContractFields() {
        const tipoContrato = document.getElementById('tipo_contrato_id')?.value;
        const vencimientoField = document.getElementById('campo-vencimiento');
        const vencimientoInput = document.getElementById('fecha_vencimiento_contrato');
        if (!vencimientoField || !vencimientoInput) return;
        
        if (tipoContrato === '2') { // Suponiendo que 2 es Plazo Fijo
            vencimientoField.style.display = 'block';
            vencimientoInput.setAttribute('data-validation', 'required');
        } else {
            vencimientoField.style.display = 'none';
            vencimientoInput.removeAttribute('data-validation');
            vencimientoInput.value = '';
        }
    }

    calculateAge() {
        const birthDate = document.getElementById('fecha_nacimiento');
        const ageDisplay = document.querySelector('.age-display');
        if (!birthDate?.value || !ageDisplay) { if(ageDisplay) ageDisplay.textContent = ''; return; }
        let age = new Date().getFullYear() - new Date(birthDate.value).getFullYear();
        ageDisplay.textContent = age >= 0 ? `${age} años` : '';
    }

    updateReviewSection() { 
        const reviewContainer = document.querySelector('.review-cards');
        if (!reviewContainer) return;
        const formData = new FormData(this.form);
        let html = '';
        const sections = {
            'Información Personal': ['rut', 'nombre_completo', 'fecha_nacimiento', 'telefono', 'correo_electronico', 'direccion', 'region_id', 'comuna_id', 'genero_id', 'nacionalidad_id'],
            'Información Laboral': ['id_sap_local', 'id_sap_global', 'fecha_ingreso', 'tipo_contrato_id', 'fecha_vencimiento_contrato'],
            'Asignaciones': ['cargo_id', 'area_id', 'turno_id', 'supervision_id', 'nomina_id', 'acreditacion_id', 'distribucion_categoria_id', 'tipo_pasaje_id', 'fase_id', 'relacion_laboral_id', 'status_id']
        };

        for (const [title, fields] of Object.entries(sections)) {
            html += `<div class="card mb-3"><div class="card-header">${title}</div><div class="card-body row">`;
            for (const fieldName of fields) {
                const field = this.form.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    let value = field.value || 'No asignado';
                    if(field.tagName === 'SELECT' && field.options[field.selectedIndex]){
                       value = field.options[field.selectedIndex].text || 'No asignado';
                    }
                    html += `<div class="col-md-4 mb-2"><strong>${field.labels[0].textContent.replace('*','').trim()}:</strong><br>${value}</div>`;
                }
            }
            html += `</div></div>`;
        }
        reviewContainer.innerHTML = html;
     }

    async submitForm() {
        if (!document.getElementById('confirm-data')?.checked) {
            showToast('Debe confirmar que los datos son correctos', 'warning');
            return;
        }
        this.submitBtn.disabled = true;
        this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';

        const endpoint = this.isEditing ? `/actualizar/${this.editingId}` : '/agregar';
        const formData = new FormData(this.form);

        try {
            const data = await this.formSubmitManager.submitForm(endpoint, formData);
            
            showToast(data.message || (this.isEditing ? 'Empleado actualizado' : 'Empleado guardado'), 'success');
            this.bsModal.hide();
            setTimeout(() => window.location.reload(), 1500);

        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            this.submitBtn.disabled = false;
            this.submitBtn.innerHTML = this.isEditing 
                ? '<i class="fas fa-save me-1"></i>Actualizar' 
                : '<i class="fas fa-save me-1"></i>Guardar Empleado';
        }
    }

    resetModal() {
        if(this.form) this.form.reset();
        this.goToStep(1);
        document.querySelectorAll('.is-valid, .is-invalid').forEach(el => el.classList.remove('is-valid', 'is-invalid'));
        document.querySelectorAll('.form-feedback').forEach(el => el.textContent = '');
    }
}


// ============================================
// SISTEMA DE CARGA MASIVA (SIMPLE) - RESTAURADO Y FUNCIONAL
// ============================================
class EmployeeMassUpload {
    constructor() {
        this.selectedFile = null;
        this.initElements();
        this.bindEvents();
        this.setupDragAndDrop();
    }
    
    initElements() {
        this.dropzone = document.getElementById('file-dropzone');
        this.fileInput = document.getElementById('file-input');
        this.browseBtn = document.getElementById('browse-files');
        this.filePreview = document.getElementById('file-preview');
        this.uploadBtn = document.getElementById('upload-btn');
        this.removeBtn = document.getElementById('remove-file');
    }
    
    bindEvents() {
        if (this.browseBtn) this.browseBtn.addEventListener('click', () => this.fileInput?.click());
        if (this.fileInput) this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        if (this.uploadBtn) this.uploadBtn.addEventListener('click', () => this.startUpload());
        if (this.removeBtn) this.removeBtn.addEventListener('click', () => this.removeFile());
        
        document.getElementById('download-template')?.addEventListener('click', () => this.downloadTemplate());
        document.getElementById('view-instructions')?.addEventListener('click', () => this.showInstructions());
        document.getElementById('download-template-modal')?.addEventListener('click', () => this.downloadTemplate());
    }
    
    setupDragAndDrop() {
        if (!this.dropzone) return;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => this.dropzone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false));
        ['dragenter', 'dragover'].forEach(eName => this.dropzone.addEventListener(eName, () => this.dropzone.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(eName => this.dropzone.addEventListener(eName, () => this.dropzone.classList.remove('drag-over'), false));
        this.dropzone.addEventListener('drop', (e) => this.handleDrop(e), false);
    }
    
    handleDrop(e) { if (e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]); }
    
    handleFileSelect(e) { if (e.target.files.length) this.handleFile(e.target.files[0]); }

    handleFile(file) {
        if (!this.validateFile(file)) return;
        this.selectedFile = file;
        this.showFilePreview(file);
    }

    validateFile(file) {
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
            'application/vnd.ms-excel', 
            'text/csv'
        ];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (!allowedTypes.includes(file.type) && !/\.(xlsx|xls|csv)$/i.test(file.name)) {
            showToast('Tipo de archivo no válido. Solo Excel (.xlsx, .xls) o CSV', 'error');
            return false;
        }
        
        if (file.size > maxSize) {
            showToast('Archivo muy grande. Máximo 10MB', 'error');
            return false;
        }
        return true;
    }
    
    showFilePreview(file) {
        const fileNameEl = document.getElementById('file-name');
        const fileSizeEl = document.getElementById('file-size');
        if(fileNameEl) fileNameEl.textContent = file.name;
        if(fileSizeEl) fileSizeEl.textContent = this.formatFileSize(file.size);

        document.getElementById('dropzone-content')?.classList.add('d-none');
        document.getElementById('file-preview')?.classList.remove('d-none');
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async startUpload() {
        if (!this.selectedFile) {
            showToast('No hay archivo seleccionado', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('archivo_excel', this.selectedFile);
        
        showToast('Iniciando carga masiva...', 'info');
        try {
            const response = await fetch('/upload_empleados', { method: 'POST', body: formData });
            // La respuesta de Flask ahora es una redirección, no un JSON.
            // Por lo tanto, no se puede leer como JSON. Asumimos éxito si la respuesta es OK.
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`Error en el servidor: ${errorText}`);
            }
            showToast('Carga completada. La página se recargará.', 'success');
            setTimeout(() => window.location.reload(), 2000);
        } catch (error) {
            showToast(`Error al cargar el archivo: ${error.message}`, 'error');
        }
    }

    showResults(result) {
        const resultsDiv = document.getElementById('upload-results');
        const summaryDiv = document.getElementById('results-summary');
        if (resultsDiv && summaryDiv) {
            summaryDiv.innerHTML = `<p><strong>Total:</strong> ${result.total || 0}, <strong>Importados:</strong> ${result.imported || 0}, <strong>Saltados:</strong> ${result.skipped || 0}, <strong>Errores:</strong> ${result.errors || 0}</p>`;
            resultsDiv.classList.remove('d-none');
        }
    }
    
    removeFile() {
        this.selectedFile = null;
        if(this.fileInput) this.fileInput.value = '';
        document.getElementById('dropzone-content')?.classList.remove('d-none');
        document.getElementById('file-preview')?.classList.add('d-none');
    }
    
    downloadTemplate() {
        try {
            const templateData = [['RUT', 'Nombre Completo', 'Fecha Ingreso', 'Cargo', 'Area', 'Turno']];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, 'Empleados');
            XLSX.writeFile(wb, 'plantilla_empleados.xlsx');
            showToast('Plantilla descargada', 'success');
        } catch (error) {
            showToast('Error al descargar plantilla', 'error');
        }
    }
    
    showInstructions() {
        const modalEl = document.getElementById('instructionsModal');
        if(modalEl) new bootstrap.Modal(modalEl).show();
    }
}


// ============================================
// MODAL DE IMPORTACIÓN INTELIGENTE (CÓDIGO COMPLETO)
// ============================================
class SmartImportManager {
    constructor() {
        this.modalEl = document.getElementById('realTimeImportModal');
        if (!this.modalEl) return;
        this.modal = new bootstrap.Modal(this.modalEl);
        this.currentStep = 1; this.totalSteps = 4; this.fileData = []; this.validatedData = []; this.errors = [];
        this.headers = [];
        this.initElements(); this.bindEvents();
    }
    initElements() {
        this.steps = this.modalEl.querySelectorAll('.import-step');
        this.stepIndicators = this.modalEl.querySelectorAll('.step-indicator .step');
        this.nextBtn = document.getElementById('next-import-step');
        this.prevBtn = document.getElementById('prev-import-step');
        this.startImportBtn = document.getElementById('start-import');
        this.dropzone = document.getElementById('advanced-dropzone');
        this.fileInput = document.getElementById('advanced-file-input');
        this.browseBtn = document.getElementById('browse-advanced');
        this.importStatus = document.getElementById('import-status');
        this.validationProgressBar = document.getElementById('validation-progress-bar');
        this.totalRowsEl = document.getElementById('total-rows');
        this.validRowsEl = document.getElementById('valid-rows');
        this.errorRowsEl = document.getElementById('error-rows');
        this.previewTableHead = document.querySelector('#preview-table thead');
        this.previewTableBody = document.querySelector('#preview-table tbody');
        this.errorsContainer = document.getElementById('errors-container');
        this.errorCountHeader = document.getElementById('error-count-header');
        this.finalValidEl = document.getElementById('final-valid');
        this.finalNewEl = document.getElementById('final-new');
        this.finalUpdatesEl = document.getElementById('final-updates');
        this.finalSkippedEl = document.getElementById('final-skipped');
    }
    bindEvents() {
        this.nextBtn.addEventListener('click', () => this.goToNextStep());
        this.prevBtn.addEventListener('click', () => this.goToPrevStep());
        this.browseBtn.addEventListener('click', () => this.fileInput.click());
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
        this.dropzone.addEventListener('dragover', (e) => { e.preventDefault(); this.dropzone.classList.add('drag-over'); });
        this.dropzone.addEventListener('dragleave', () => this.dropzone.classList.remove('drag-over'));
        this.dropzone.addEventListener('drop', (e) => { e.preventDefault(); this.dropzone.classList.remove('drag-over'); this.handleFileSelect(e.dataTransfer.files); });
        this.startImportBtn.addEventListener('click', () => this.startImport());
        this.modalEl.addEventListener('hidden.bs.modal', () => this.reset());
    }
    goToStep(stepNumber) {
        this.currentStep = stepNumber;
        this.steps.forEach(step => { step.style.display = parseInt(step.dataset.step) === this.currentStep ? 'block' : 'none'; });
        this.stepIndicators.forEach(indicator => {
            const step = parseInt(indicator.dataset.step);
            indicator.classList.remove('active', 'completed');
            if (step < this.currentStep) indicator.classList.add('completed');
            if (step === this.currentStep) indicator.classList.add('active');
        });
        this.prevBtn.style.display = this.currentStep > 1 ? 'inline-block' : 'none';
        this.nextBtn.style.display = this.currentStep < this.totalSteps ? 'inline-block' : 'none';
        this.startImportBtn.style.display = this.currentStep === this.totalSteps ? 'inline-block' : 'none';
        this.nextBtn.disabled = (this.currentStep === 1 && this.fileData.length === 0) || (this.currentStep === 3 && this.errors.length > 0);
    }
    goToNextStep() {
        if (this.currentStep === 1) this.runValidation();
        else if (this.currentStep === 2) this.prepareErrorCorrection();
        else if (this.currentStep === 3) this.prepareFinalSummary();
        if (this.currentStep < this.totalSteps) this.goToStep(this.currentStep + 1);
    }
    goToPrevStep() {
        if (this.currentStep > 1) this.goToStep(this.currentStep - 1);
    }
    handleFileSelect(files) {
        if (!files.length) return;
        this.importStatus.textContent = `Procesando ${files[0].name}...`;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" });
                if(sheetData.length < 2) throw new Error("La hoja de cálculo está vacía o no tiene datos.");
                this.headers = sheetData[0].map(h => h.toString().trim());
                this.fileData = sheetData.slice(1);
                showToast(`Archivo cargado. ${this.fileData.length} registros.`, 'success');
                this.importStatus.textContent = `Archivo cargado: ${this.fileData.length} registros.`;
                this.nextBtn.disabled = false;
            } catch (e) { showToast(`Error al leer el archivo: ${e.message}`, 'error'); this.reset(); }
        };
        reader.readAsArrayBuffer(files[0]);
    }
    async runValidation() {
        this.goToStep(2);
        this.errors = [];
        this.validatedData = [];
        let validCount = 0;
        const totalRows = this.fileData.length;
        this.totalRowsEl.textContent = totalRows;

        for (let i = 0; i < totalRows; i++) {
            const rowArray = this.fileData[i];
            const rowObject = this.headers.reduce((obj, header, index) => {
                obj[header] = rowArray[index] || "";
                return obj;
            }, {});

            const rowErrors = [];
            if (!rowObject['RUT'] || !rowObject['Nombre Completo']) {
                rowErrors.push({ field: 'RUT/Nombre', value: '', message: 'RUT y Nombre Completo son obligatorios.' });
            }
            if (rowObject['RUT'] && !this.validateRutFormat(rowObject['RUT'].toString())) {
                rowErrors.push({ field: 'RUT', value: rowObject['RUT'], message: 'Formato de RUT inválido.' });
            }

            if (rowErrors.length > 0) {
                this.errors.push({ rowIndex: i + 2, originalRow: rowObject, errors: rowErrors });
            } else {
                this.validatedData.push(rowObject);
                validCount++;
            }

            this.validRowsEl.textContent = validCount;
            this.errorRowsEl.textContent = this.errors.length;
            this.validationProgressBar.style.width = `${((i + 1) / totalRows) * 100}%`;
            if (i % 100 === 0) await new Promise(resolve => setTimeout(resolve, 0)); 
        }
        this.renderPreview();
        this.nextBtn.disabled = false; // Siempre permitir ir a corregir errores
    }
    renderPreview() {
        this.previewTableHead.innerHTML = `<tr>${this.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        let tableHtml = '';
        const errorRowIndexes = new Set(this.errors.map(e => e.rowIndex));

        this.fileData.forEach((row, index) => {
            const isError = errorRowIndexes.has(index + 2);
            tableHtml += `<tr class="${isError ? 'table-danger' : ''}">`;
            row.forEach(cell => {
                tableHtml += `<td>${cell}</td>`;
            });
            tableHtml += `</tr>`;
        });
        this.previewTableBody.innerHTML = tableHtml;
    }
    prepareErrorCorrection() {
        this.errorCountHeader.textContent = this.errors.length;
        if(this.errors.length === 0){
             this.errorsContainer.innerHTML = `<div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>¡Excelente! No se encontraron errores de validación.</div>`;
             this.nextBtn.disabled = false;
             return;
        }
        this.nextBtn.disabled = true; // Deshabilitar hasta que los errores se manejen
        let errorHtml = '';
        this.errors.forEach(errorItem => {
            errorHtml += `
                <div class="card error-card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Error en Fila ${errorItem.rowIndex}</h6>
                        <div class="error-details">
                            ${errorItem.errors.map(err => `
                                <div class="error-field">
                                    <strong>${err.field}:</strong> 
                                    <span>${err.value || '<em>vacío</em>'}</span>
                                </div>
                                <div class="error-message">
                                    <small class="text-muted">${err.message}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        });
        this.errorsContainer.innerHTML = errorHtml;
    }
    prepareFinalSummary() {
        const newCount = this.validatedData.length;
        const updatesCount = 0; 
        const skippedCount = this.errors.length;

        this.finalValidEl.textContent = newCount + updatesCount;
        this.finalNewEl.textContent = newCount;
        this.finalUpdatesEl.textContent = updatesCount;
        this.finalSkippedEl.textContent = skippedCount;
    }
    async startImport() {
        const progressModal = new bootstrap.Modal(document.getElementById('importProgressModal'));
        progressModal.show();

        const totalRecords = this.validatedData.length;
        const progressBar = document.getElementById('import-progress-bar');
        const currentRecordEl = document.getElementById('current-record');
        const totalRecordsEl = document.getElementById('total-records');
        totalRecordsEl.textContent = totalRecords;
        
        for (let i = 0; i < totalRecords; i++) {
            currentRecordEl.textContent = i + 1;
            progressBar.style.width = `${((i + 1) / totalRecords) * 100}%`;
            // En un caso real, aquí iría la llamada fetch para cada registro o para un lote
            await new Promise(r => setTimeout(r, 20)); 
        }
        
        setTimeout(() => {
            progressModal.hide();
            this.modal.hide();
            showToast('Importación completada con éxito!', 'success');
             setTimeout(() => window.location.reload(), 1500);
        }, 1000);
    }
    
    // ==========================================================
    // =====> INICIO DE LA CORRECCIÓN: ALGORITMO DE RUT CORRECTO
    // ==========================================================
    validateRutFormat(rut) {
        if (!rut || typeof rut !== 'string') return false;
        
        const cleanRut = rut.replace(/[^0-9kK]/g, '').toUpperCase();
        if (cleanRut.length < 2) return false;
        
        const body = cleanRut.slice(0, -1);
        const dv = cleanRut.slice(-1);
        
        if(!/^\d+$/.test(body)) return false;

        let sum = 0;
        let multiplier = 2;
        for (let i = body.length - 1; i >= 0; i--) {
            sum += parseInt(body[i]) * multiplier;
            multiplier = multiplier === 7 ? 2 : multiplier + 1;
        }
        const calculatedDvRaw = 11 - (sum % 11);
        
        if (calculatedDvRaw == 11) return dv == '0';
        if (calculatedDvRaw == 10) return dv == 'K';
        return dv == calculatedDvRaw.toString();
    }
    // ==========================================================
    // =====> FIN DE LA CORRECCIÓN
    // ==========================================================
    
    reset() {
        this.currentStep = 1;
        this.fileData = [];
        this.validatedData = [];
        this.errors = [];
        this.headers = [];
        this.fileInput.value = '';
        this.importStatus.textContent = 'Seleccione un archivo para comenzar';
        this.nextBtn.disabled = true;
        this.goToStep(1);
    }
}


// ============================================
// ACTUALIZACIÓN POR LOTES (CORREGIDO)
// ============================================
function initializeBatchUpdate() {
    const processBtn = document.getElementById('process-batch-update-btn');
    if (!processBtn) return;
    processBtn.addEventListener('click', async () => {
        const resultsContainer = document.getElementById('batch-update-results');
        const resultsAlert = document.getElementById('batch-update-alert');
        const batchData = document.getElementById('batch_data').value;
        const btnText = document.getElementById('process-btn-text');
        const btnSpinner = document.getElementById('process-btn-spinner');
        if (!batchData.trim()) { showToast('Pega los datos a procesar.', 'warning'); return; }
        
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-block';
        processBtn.disabled = true;

        try {
            const response = await fetch('/api/actualizar_lote', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    identifier_field: document.getElementById('identifier_field').value,
                    update_field: document.getElementById('update_field').value,
                    pasted_data: batchData
                })
            });
            const data = await response.json();

            resultsContainer.style.display = 'block';
            if (data.success) {
                resultsAlert.className = 'alert alert-success';
                let message = `<strong>Éxito!</strong> Actualizados: ${data.actualizados}.`;
                if (data.no_encontrados > 0) {
                    message += `<br>No encontrados: ${data.no_encontrados}. <small>(${data.lista_no_encontrados.slice(0, 5).join(', ')}${data.no_encontrados > 5 ? '...' : ''})</small>`;
                }
                resultsAlert.innerHTML = message;
                showToast('Proceso completado', 'success');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                throw new Error(data.message || 'Error en el servidor');
            }
        } catch (error) {
            resultsContainer.style.display = 'block';
            resultsAlert.className = 'alert alert-danger';
            resultsAlert.innerHTML = `<strong>Error:</strong> ${error.message}`;
            showToast(error.message, 'error');
        } finally {
            btnText.style.display = 'inline-block';
            btnSpinner.style.display = 'none';
            processBtn.disabled = false;
        }
    });
}


// ============================================
// FUNCIONES DE UTILIDAD (RESTAURADAS)
// ============================================
function initializeAjaxSearch() {
    const searchForm = document.getElementById('ajax-search-form');
    if (!searchForm) return;

    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const query = document.getElementById('query').value;
        const searchBy = document.getElementById('search_by').value;

        const searchBtn = document.getElementById('search-btn');
        const spinner = document.getElementById('search-spinner');
        
        spinner?.classList.remove('d-none');
        searchBtn?.setAttribute('disabled', 'true');
        
        try {
            // CORRECCIÓN 1: Apuntar a la ruta correcta de la API
            const response = await fetch('/api/search_employees', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query, search_by: searchBy})
            });

            const data = await response.json();

            // Si la API devuelve un error, lo mostramos
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido en la búsqueda');
            }
            
            // CORRECCIÓN 2: Usar 'data.employees' en lugar de 'data.empleados'
            updateEmployeeTable(data.employees);
            // CORRECCIÓN 3: Usar 'data.total' en lugar de 'data.count'
            showToast(`${data.total || 0} empleados encontrados`, 'success');

        } catch (error) {
            showToast(`Error al buscar: ${error.message}`, 'error');
        } finally {
            spinner?.classList.add('d-none');
            searchBtn?.removeAttribute('disabled');
        }
    });
}

function updateEmployeeTable(empleados) {
    const tbody = document.querySelector('table.table tbody');
    if (!tbody) return;

    if (!empleados || !empleados.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center p-5">No se encontraron empleados</td></tr>`;
        return;
    }

    tbody.innerHTML = empleados.map(empleado => `
        <tr>
            <td>
                <div class="form-check">
                    <input type="checkbox" name="empleado_ids" value="${empleado.id}" class="employee-checkbox form-check-input" id="checkbox-${empleado.id}">
                </div>
            </td>
            <td><span class="clickable-field" data-checkbox="checkbox-${empleado.id}">${empleado.rut}</span></td>
            <td>${empleado.nombre_completo}</td>
            <td><span class="badge bg-info-subtle text-info-emphasis clickable-field" data-checkbox="checkbox-${empleado.id}">${empleado.id_sap_local || 'N/A'}</span></td>
            <td>${empleado.telefono || 'N/A'}</td>
            <td>${empleado.cargo_nombre || 'N/A'}</td>
            <td>${empleado.area_nombre || 'N/A'}</td>
            <td><span class="badge ${empleado.status_nombre === 'Vigente' ? 'bg-success' : 'bg-danger'}">${empleado.status_nombre || 'N/A'}</span></td>
            <td class="text-end">
                <div class="d-flex gap-2 justify-content-end">
                    <a href="/editar/${empleado.id}" class="btn btn-outline-primary btn-sm" title="Editar"><i class="fas fa-pencil-alt"></i></a>
                    <form action="/eliminar/${empleado.id}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar" onclick="return confirm('¿Seguro?');"><i class="fas fa-trash-alt"></i></button>
                    </form>
                </div>
            </td>
        </tr>
    `).join('');
    
    initializeMassSelectionEvents(); // Re-bind events for new elements
}

function initializeMassSelectionEvents() {
    const selectAllVisible = () => document.querySelectorAll('.employee-checkbox').forEach(cb => { cb.checked = true; updateClickableField(cb.id, true); });
    const deselectAll = () => document.querySelectorAll('.employee-checkbox').forEach(cb => { cb.checked = false; updateClickableField(cb.id, false); });
    const invertSelection = () => document.querySelectorAll('.employee-checkbox').forEach(cb => { cb.checked = !cb.checked; updateClickableField(cb.id, cb.checked); });
    
    document.getElementById('select-all-visible')?.addEventListener('click', () => { selectAllVisible(); updateSelectionDisplay(); updateSelectAllState(); });
    document.getElementById('deselect-all')?.addEventListener('click', () => { deselectAll(); updateSelectionDisplay(); updateSelectAllState(); });
    document.getElementById('invert-selection')?.addEventListener('click', () => { invertSelection(); updateSelectionDisplay(); updateSelectAllState(); });

    document.getElementById('select-all')?.addEventListener('change', function() {
        document.querySelectorAll('.employee-checkbox').forEach(cb => { cb.checked = this.checked; updateClickableField(cb.id, this.checked); });
        updateSelectionDisplay();
    });
    
    document.querySelectorAll('.clickable-field').forEach(field => {
        field.addEventListener('click', function() {
            const checkbox = document.getElementById(this.dataset.checkbox);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateClickableField(checkbox.id, checkbox.checked);
                updateSelectionDisplay();
                updateSelectAllState();
            }
        });
    });

    document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateClickableField(this.id, this.checked);
            updateSelectionDisplay();
            updateSelectAllState();
        });
    });
}

function updateClickableField(checkboxId, isChecked) {
    document.querySelectorAll(`[data-checkbox="${checkboxId}"]`).forEach(field => field.classList.toggle('selected', isChecked));
}

function updateSelectionDisplay() {
    const count = document.querySelectorAll('.employee-checkbox:checked').length;
    const display = document.getElementById('selection-display');
    const message = document.getElementById('selection-message');
    if (display) {
        display.textContent = `${count} empleados seleccionados`;
        display.style.display = count > 0 ? 'inline-block' : 'none';
    }
    if (message) message.style.display = count > 0 ? 'block' : 'none';
}

function updateSelectAllState() {
    const selectAll = document.getElementById('select-all');
    if (!selectAll) return;
    const allCheckboxes = document.querySelectorAll('.employee-checkbox');
    const checkedCount = document.querySelectorAll('.employee-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
    } else if (checkedCount === allCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
    } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
    }
}

function initializeBulkActions() {
    const accionSelect = document.getElementById('accion');
    if (!accionSelect) return;

    accionSelect.addEventListener('change', function() {
        const valorContainer = document.getElementById('valor-container');
        const fechaContainer = document.getElementById('fecha-container');
        const selectedAction = this.value;

        // Hide all conditional inputs first
        valorContainer.style.display = 'none';
        fechaContainer.style.display = 'none';
        document.querySelectorAll('.value-select, .value-input').forEach(el => el.style.display = 'none');

        if (selectedAction.startsWith('planificar-')) {
            fechaContainer.style.display = 'block';
        } else if (['area_id', 'turno_id', 'status_id', 'acreditacion_id', 'nomina_id'].includes(selectedAction)) {
            valorContainer.style.display = 'block';
            document.getElementById(`select_${selectedAction}`).style.display = 'block';
        } else if (selectedAction === 'direccion') {
            valorContainer.style.display = 'block';
            document.getElementById('input_direccion').style.display = 'block';
        }
    });
}

// ============================================
// INICIALIZACIÓN COMPLETA DEL SISTEMA
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (typeof bootstrap === 'undefined') throw new Error('Bootstrap no está cargado');
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-bs-theme', savedTheme);
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        // Inicializar todas las clases y funcionalidades
        window.advancedEmployeeModal = new AdvancedEmployeeModal();
        window.employeeMassUpload = new EmployeeMassUpload();
        window.smartImportManager = new SmartImportManager();
        
        // Inicializar funciones de la página
        initializeAjaxSearch();
        initializeMassSelectionEvents();
        initializeBulkActions();
        initializeBatchUpdate();

        // Conectar botones a sus modales
        document.getElementById('new-employee-modal-btn')?.addEventListener('click', () => window.advancedEmployeeModal.openForNew());
        document.getElementById('open-real-time-import-modal')?.addEventListener('click', () => window.smartImportManager.modal.show());
        
        console.log('🎉 Sistema inicializado exitosamente');
        
    } catch (error) {
        console.error('❌ Error crítico en inicialización:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger m-3';
        errorDiv.innerHTML = `<h4>Error al inicializar</h4><p>${error.message}</p><p>Recargue la página.</p>`;
        document.body.insertBefore(errorDiv, document.body.firstChild);
    }
});
</script>
{% endblock %}